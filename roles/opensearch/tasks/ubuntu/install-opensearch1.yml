##
#   Copyright 2022 TechDivision GmbH
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.
##
---

- name: Set current opensearch base path
  ansible.builtin.set_fact:
    current_opensearch_base_path: "{{ opensearch_base_path }}1"
    current_opensearch_key: "opensearch1"

- name: "Get stats for dir {{ current_opensearch_base_path }}"
  ansible.builtin.stat:
    path: "{{ current_opensearch_base_path }}"
  register: current_opensearch_base_path_obj

- name: "Block"
  when: not current_opensearch_base_path_obj.stat.exists
  block:
    - name: Download opensearch package
      ansible.builtin.get_url:
        url: "{{ opensearch_version_1_download_url }}"
        dest: "/tmp/{{ current_opensearch_key }}.tar.gz"

    - name: "Create {{ current_opensearch_base_path }}"
      ansible.builtin.file:
        path: "{{ current_opensearch_base_path }}"
        owner: "{{ current_user }}"
        group: "{{ current_group }}"
        mode: '0755'
        state: directory
      become: true

    - name: Extract opensearch archive
      ansible.builtin.unarchive:
        src: "/tmp/{{ current_opensearch_key }}.tar.gz"
        dest: "{{ current_opensearch_base_path }}"
        extra_opts: [--strip-components=1]

    - name: "Delete opensearch release tar.gz"
      ansible.builtin.file:
        path: "/tmp/{{ current_opensearch_key }}.tar.gz"
        state: absent

    - name: "Install plugins"
      ansible.builtin.shell: "{{ current_opensearch_base_path }}/bin/opensearch-plugin install {{ current_opensearch_plugin }}"
      with_items: "{{ opensearch_plugins }}"
      loop_control:
        loop_var: current_opensearch_plugin

- name: "Provide {{ current_opensearch_key }} configuration"
  ansible.builtin.template:
    src: "config/{{ current_opensearch_key }}.yml.j2"
    dest: "{{ current_opensearch_base_path }}/config/opensearch.yml"
    mode: '0644'
  notify: "Systemd | opensearch1 | restarted"

- name: "Set 'Xms' in '{{ current_opensearch_base_path }}/config/jvm.options' to 2GB"
  ansible.builtin.lineinfile:
    path: "{{ current_opensearch_base_path }}/config/jvm.options"
    regexp: '^-Xms'
    line: "-Xms2g"
  notify: "Systemd | opensearch1 | restarted"

- name: "Set 'Xmx' in '{{ current_opensearch_base_path }}/config/jvm.options' to 2GB"
  ansible.builtin.lineinfile:
    path: "{{ current_opensearch_base_path }}/config/jvm.options"
    regexp: '^-Xmx'
    line: "-Xmx2g"
  notify: "Systemd | opensearch1 | restarted"

- name: "Provide {{ current_opensearch_key }} systemd unit file"
  ansible.builtin.template:
    src: "systemd/{{ current_opensearch_key }}.service.j2"
    dest: "/etc/systemd/system/{{ current_opensearch_key }}.service"
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: "Systemd | opensearch1 | restarted"
